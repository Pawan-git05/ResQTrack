<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Admin Dashboard - ResQTrack</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
	<link href="./assets/css/styles.css" rel="stylesheet" />
	<script src="./config.js"></script>
	<!-- Leaflet CSS -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
	      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
	      crossorigin=""/>
	<!-- Leaflet JS -->
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
	        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
	        crossorigin=""></script>
	<style>
		.stats-card {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border-radius: 10px;
			padding: 20px;
			margin-bottom: 20px;
		}
		.stats-number {
			font-size: 2.5rem;
			font-weight: bold;
		}
		.table-responsive {
			border-radius: 10px;
			overflow: hidden;
			box-shadow: 0 4px 6px rgba(0,0,0,0.1);
		}
		.badge-status {
			font-size: 0.8rem;
		}
		.refresh-btn {
			position: fixed;
			bottom: 20px;
			right: 20px;
			z-index: 1000;
		}
	</style>
</head>
<body>
	<nav class="navbar navbar-expand-lg bg-body-tertiary">
		<div class="container">
			<a class="navbar-brand" href="./index.html">üêæ <span>ResQTrack</span></a>
			<div class="navbar-nav ms-auto">
				<a class="nav-link" href="./index.html">Home</a>
				<a class="nav-link active" href="./admin.html">Admin</a>
				<a class="nav-link" href="./data-dashboard.html">Data Dashboard</a>
			</div>
		</div>
	</nav>
	
	<div class="container py-4">
		<h1 class="h3 mb-4">üìä Admin Dashboard</h1>
		
		<!-- Statistics Cards -->
		<div class="row mb-4">
			<div class="col-md-3">
				<div class="stats-card text-center">
					<div class="stats-number" id="total-cases">-</div>
					<div>Total Cases</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="stats-card text-center">
					<div class="stats-number" id="total-ngos">-</div>
					<div>Registered NGOs</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="stats-card text-center">
					<div class="stats-number" id="total-volunteers">-</div>
					<div>Volunteers</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="stats-card text-center">
					<div class="stats-number" id="total-donations">-</div>
					<div>Donations</div>
				</div>
			</div>
		</div>

		<!-- CSV Import Section -->
		<div class="row mb-4">
			<div class="col-12">
				<div class="card">
					<div class="card-header">
						<h5 class="card-title mb-0">üìÅ CSV Import</h5>
					</div>
					<div class="card-body">
						<div class="row">
							<div class="col-md-3">
								<button class="btn btn-outline-primary w-100 mb-2" onclick="openUploadModal('hospitals')">
									üè• Import Hospitals
								</button>
								<button class="btn btn-outline-secondary btn-sm w-100" onclick="downloadSample('hospitals')">
									üì• Sample CSV
								</button>
							</div>
							<div class="col-md-3">
								<button class="btn btn-outline-primary w-100 mb-2" onclick="openUploadModal('police-stations')">
									üöî Import Police Stations
								</button>
								<button class="btn btn-outline-secondary btn-sm w-100" onclick="downloadSample('police-stations')">
									üì• Sample CSV
								</button>
							</div>
							<div class="col-md-3">
								<button class="btn btn-outline-primary w-100 mb-2" onclick="openUploadModal('blood-banks')">
									ü©∏ Import Blood Banks
								</button>
								<button class="btn btn-outline-secondary btn-sm w-100" onclick="downloadSample('blood-banks')">
									üì• Sample CSV
								</button>
							</div>
							<div class="col-md-3">
								<button class="btn btn-outline-primary w-100 mb-2" onclick="openUploadModal('fire-stations')">
									üöí Import Fire Stations
								</button>
								<button class="btn btn-outline-secondary btn-sm w-100" onclick="downloadSample('fire-stations')">
									üì• Sample CSV
								</button>
							</div>
						</div>
						<div class="row mt-2">
							<div class="col-md-3">
								<button class="btn btn-outline-primary w-100 mb-2" onclick="openUploadModal('emergency-contacts')">
									üìû Import Emergency Contacts
								</button>
								<button class="btn btn-outline-secondary btn-sm w-100" onclick="downloadSample('emergency-contacts')">
									üì• Sample CSV
								</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Tabs for different data views -->
		<ul class="nav nav-tabs" id="adminTabs" role="tablist">
			<li class="nav-item" role="presentation">
				<button class="nav-link active" id="cases-tab" data-bs-toggle="tab" data-bs-target="#cases" type="button" role="tab">
					üö® Cases
				</button>
			</li>
			<li class="nav-item" role="presentation">
				<button class="nav-link" id="ngos-tab" data-bs-toggle="tab" data-bs-target="#ngos" type="button" role="tab">
					üè¢ NGOs
				</button>
			</li>
			<li class="nav-item" role="presentation">
				<button class="nav-link" id="volunteers-tab" data-bs-toggle="tab" data-bs-target="#volunteers" type="button" role="tab">
					üë• Volunteers
				</button>
			</li>
			<li class="nav-item" role="presentation">
				<button class="nav-link" id="donations-tab" data-bs-toggle="tab" data-bs-target="#donations" type="button" role="tab">
					üí∞ Donations
				</button>
			</li>
			<li class="nav-item" role="presentation">
				<button class="nav-link" id="hospitals-tab" data-bs-toggle="tab" data-bs-target="#hospitals" type="button" role="tab">
					üè• Hospitals
				</button>
			</li>
			<li class="nav-item" role="presentation">
				<button class="nav-link" id="police-tab" data-bs-toggle="tab" data-bs-target="#police" type="button" role="tab">
					üöî Police Stations
				</button>
			</li>
			<li class="nav-item" role="presentation">
				<button class="nav-link" id="blood-banks-tab" data-bs-toggle="tab" data-bs-target="#blood-banks" type="button" role="tab">
					ü©∏ Blood Banks
				</button>
			</li>
			<li class="nav-item" role="presentation">
				<button class="nav-link" id="fire-stations-tab" data-bs-toggle="tab" data-bs-target="#fire-stations" type="button" role="tab">
					üöí Fire Stations
				</button>
			</li>
			<li class="nav-item" role="presentation">
				<button class="nav-link" id="emergency-contacts-tab" data-bs-toggle="tab" data-bs-target="#emergency-contacts" type="button" role="tab">
					üìû Emergency Contacts
				</button>
			</li>
		</ul>

		<div class="tab-content border border-top-0 p-3" id="adminTabContent">
			<!-- Cases Tab -->
			<div class="tab-pane fade show active" id="cases" role="tabpanel">
				<div class="table-responsive">
					<table class="table table-hover">
						<thead class="table-dark">
							<tr>
								<th>Case Code</th>
								<th>Reporter</th>
								<th>Location</th>
								<th>Animal</th>
								<th>Urgency</th>
								<th>Status</th>
								<th>Date</th>
							</tr>
						</thead>
						<tbody id="cases-table-body">
							<tr><td colspan="7" class="text-center">Loading...</td></tr>
						</tbody>
					</table>
				</div>
			</div>

			<!-- NGOs Tab -->
			<div class="tab-pane fade" id="ngos" role="tabpanel">
				<div class="table-responsive">
					<table class="table table-hover">
						<thead class="table-dark">
							<tr>
								<th>Name</th>
								<th>Email</th>
								<th>Phone</th>
								<th>Location</th>
								<th>Operating Zones</th>
								<th>Status</th>
								<th>Date</th>
							</tr>
						</thead>
						<tbody id="ngos-table-body">
							<tr><td colspan="7" class="text-center">Loading...</td></tr>
						</tbody>
					</table>
				</div>
			</div>

			<!-- Volunteers Tab -->
			<div class="tab-pane fade" id="volunteers" role="tabpanel">
				<div class="table-responsive">
					<table class="table table-hover">
						<thead class="table-dark">
							<tr>
								<th>Name</th>
								<th>Email</th>
								<th>Phone</th>
								<th>Expertise</th>
								<th>Location</th>
								<th>Status</th>
								<th>Date</th>
							</tr>
						</thead>
						<tbody id="volunteers-table-body">
							<tr><td colspan="7" class="text-center">Loading...</td></tr>
						</tbody>
					</table>
				</div>
			</div>

			<!-- Donations Tab -->
			<div class="tab-pane fade" id="donations" role="tabpanel">
				<div class="table-responsive">
					<table class="table table-hover">
						<thead class="table-dark">
							<tr>
								<th>Donor</th>
								<th>Amount</th>
								<th>Category</th>
								<th>Payment ID</th>
								<th>Date</th>
							</tr>
						</thead>
						<tbody id="donations-table-body">
							<tr><td colspan="5" class="text-center">Loading...</td></tr>
						</tbody>
					</table>
				</div>
			</div>

			<!-- Hospitals Tab -->
			<div class="tab-pane fade" id="hospitals" role="tabpanel">
				<div class="mb-3">
					<div class="btn-group" role="group">
						<button type="button" class="btn btn-outline-secondary active" onclick="switchAdminView('hospitals', 'table')">
							üìã Table View
						</button>
						<button type="button" class="btn btn-outline-secondary" onclick="switchAdminView('hospitals', 'map')">
							üó∫Ô∏è Map View
						</button>
						<button type="button" class="btn btn-outline-primary" onclick="openAddLocationModal('hospital')">
							‚ûï Add Hospital
						</button>
					</div>
				</div>
				
				<div id="hospitals-table-view">
					<div class="table-responsive">
						<table class="table table-hover">
							<thead class="table-dark">
								<tr>
									<th>Name</th>
									<th>Address</th>
									<th>Phone</th>
									<th>24x7</th>
									<th>Treatment Types</th>
									<th>Date</th>
								</tr>
							</thead>
							<tbody id="hospitals-table-body">
								<tr><td colspan="6" class="text-center">Loading...</td></tr>
							</tbody>
						</table>
					</div>
				</div>
				
				<div id="hospitals-map-view" class="d-none">
					<div id="hospitals-map" style="height: 500px; border-radius: 8px; border: 1px solid #dee2e6;"></div>
				</div>
			</div>

			<!-- Police Stations Tab -->
			<div class="tab-pane fade" id="police" role="tabpanel">
				<div class="mb-3">
					<div class="btn-group" role="group">
						<button type="button" class="btn btn-outline-secondary active" onclick="switchAdminView('police', 'table')">
							üìã Table View
						</button>
						<button type="button" class="btn btn-outline-secondary" onclick="switchAdminView('police', 'map')">
							üó∫Ô∏è Map View
						</button>
						<button type="button" class="btn btn-outline-primary" onclick="openAddLocationModal('police-station')">
							‚ûï Add Police Station
						</button>
					</div>
				</div>
				
				<div id="police-table-view">
					<div class="table-responsive">
						<table class="table table-hover">
							<thead class="table-dark">
								<tr>
									<th>Name</th>
									<th>Address</th>
									<th>Phone</th>
									<th>Station Code</th>
									<th>Jurisdiction</th>
									<th>Officer in Charge</th>
									<th>24x7</th>
									<th>Date</th>
								</tr>
							</thead>
							<tbody id="police-table-body">
								<tr><td colspan="8" class="text-center">Loading...</td></tr>
							</tbody>
						</table>
					</div>
				</div>
				
				<div id="police-map-view" class="d-none">
					<div id="police-map" style="height: 500px; border-radius: 8px; border: 1px solid #dee2e6;"></div>
				</div>
			</div>

			<!-- Blood Banks Tab -->
			<div class="tab-pane fade" id="blood-banks" role="tabpanel">
				<div class="table-responsive">
					<table class="table table-hover">
						<thead class="table-dark">
							<tr>
								<th>Name</th>
								<th>Address</th>
								<th>Phone</th>
								<th>Contact Person</th>
								<th>Blood Types</th>
								<th>License Number</th>
								<th>24x7</th>
								<th>Date</th>
							</tr>
						</thead>
						<tbody id="blood-banks-table-body">
							<tr><td colspan="8" class="text-center">Loading...</td></tr>
						</tbody>
					</table>
				</div>
			</div>

			<!-- Fire Stations Tab -->
			<div class="tab-pane fade" id="fire-stations" role="tabpanel">
				<div class="table-responsive">
					<table class="table table-hover">
						<thead class="table-dark">
							<tr>
								<th>Name</th>
								<th>Address</th>
								<th>Phone</th>
								<th>Station Code</th>
								<th>Equipment Available</th>
								<th>Chief Officer</th>
								<th>24x7</th>
								<th>Date</th>
							</tr>
						</thead>
						<tbody id="fire-stations-table-body">
							<tr><td colspan="8" class="text-center">Loading...</td></tr>
						</tbody>
					</table>
				</div>
			</div>

			<!-- Emergency Contacts Tab -->
			<div class="tab-pane fade" id="emergency-contacts" role="tabpanel">
				<div class="table-responsive">
					<table class="table table-hover">
						<thead class="table-dark">
							<tr>
								<th>Name</th>
								<th>Phone</th>
								<th>Email</th>
								<th>Service Type</th>
								<th>Location</th>
								<th>Priority</th>
								<th>24x7</th>
								<th>Date</th>
							</tr>
						</thead>
						<tbody id="emergency-contacts-table-body">
							<tr><td colspan="8" class="text-center">Loading...</td></tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>

	<!-- Add Location Modal -->
	<div class="modal fade" id="addLocationModal" tabindex="-1" aria-labelledby="addLocationModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="addLocationModalLabel">üìç Add New Location</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="row">
						<div class="col-md-6">
							<form id="locationForm">
								<div class="mb-3">
									<label for="locationName" class="form-label">Name *</label>
									<input type="text" class="form-control" id="locationName" required>
								</div>
								<div class="mb-3">
									<label for="locationAddress" class="form-label">Address</label>
									<textarea class="form-control" id="locationAddress" rows="2"></textarea>
								</div>
								<div class="mb-3">
									<label for="locationPhone" class="form-label">Phone</label>
									<input type="tel" class="form-control" id="locationPhone">
								</div>
								<div class="mb-3">
									<label for="locationDescription" class="form-label">Description/Notes</label>
									<textarea class="form-control" id="locationDescription" rows="2"></textarea>
								</div>
								<div class="mb-3">
									<label for="location24x7" class="form-label">24x7 Available</label>
									<select class="form-select" id="location24x7">
										<option value="false">No</option>
										<option value="true">Yes</option>
									</select>
								</div>
								<div id="additionalFields">
									<!-- Additional fields will be populated based on location type -->
								</div>
							</form>
						</div>
						<div class="col-md-6">
							<label class="form-label">üìç Select Location on Map</label>
							<div id="locationPickerMap" style="height: 300px; border-radius: 8px; border: 1px solid #dee2e6;"></div>
							<div class="mt-2">
								<small class="text-muted">Click on the map to set the exact location</small>
								<div class="mt-1">
									<strong>Selected:</strong> <span id="selectedLocation">Not selected</span>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-primary" onclick="saveLocation()">Save Location</button>
				</div>
			</div>
		</div>
	</div>

	<!-- CSV Upload Modal -->
	<div class="modal fade" id="csvUploadModal" tabindex="-1" aria-labelledby="csvUploadModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="csvUploadModalLabel">üìÅ Upload CSV File</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<label for="csvFile" class="form-label">Select CSV File</label>
						<input type="file" class="form-control" id="csvFile" accept=".csv" />
						<div class="form-text">Please select a CSV file to upload.</div>
					</div>
					<div class="mb-3">
						<label class="form-label">CSV Format Requirements:</label>
						<div id="csvFormatInfo" class="small text-muted">
							<!-- Format info will be populated by JavaScript -->
						</div>
					</div>
					<div id="uploadProgress" class="d-none">
						<div class="progress">
							<div class="progress-bar" role="progressbar" style="width: 0%"></div>
						</div>
						<div class="text-center mt-2">Uploading...</div>
					</div>
					<div id="uploadResult" class="d-none">
						<!-- Upload results will be shown here -->
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-primary" id="uploadBtn" onclick="uploadCSV()">Upload</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Refresh Button -->
	<button class="btn btn-primary refresh-btn" onclick="loadAllData()" title="Refresh Data">
		üîÑ Refresh
	</button>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="./assets/js/app.js"></script>
	<script src="./assets/js/api.js"></script>
	<script>
		// Admin authentication
		let adminToken = null;
		
		// Map variables
		let adminMaps = {};
		let adminMarkers = {};
		let locationPickerMap = null;
		let selectedLocation = null;
		let currentLocationType = null;
		
		async function adminLogin() {
			try {
				const response = await fetch('http://localhost:5000/auth/login', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						email: 'admin@resqtrack.com',
						password: 'admin123',
						role: 'ADMIN'
					})
				});
				const data = await response.json();
				if (data.access_token) {
					adminToken = data.access_token;
					return true;
				}
				throw new Error('Login failed');
			} catch (error) {
				console.error('Admin login failed:', error);
				window.ToastManager?.error('Admin authentication failed');
				return false;
			}
		}
		
		function getAuthHeaders() {
			return {
				'Content-Type': 'application/json',
				'Authorization': `Bearer ${adminToken}`
			};
		}
		
		// Admin API functions
		window.AdminApi = {
			getAllCases: async () => {
				try { 
					if (!adminToken) await adminLogin();
					return await (await fetch('http://localhost:5000/admin/cases', { headers: getAuthHeaders() })).json(); 
				}
				catch (e) { throw e; }
			},
			getAllNGOs: async () => {
				try { 
					if (!adminToken) await adminLogin();
					return await (await fetch('http://localhost:5000/admin/ngos', { headers: getAuthHeaders() })).json(); 
				}
				catch (e) { throw e; }
			},
			getAllVolunteers: async () => {
				try { 
					if (!adminToken) await adminLogin();
					return await (await fetch('http://localhost:5000/admin/volunteers', { headers: getAuthHeaders() })).json(); 
				}
				catch (e) { throw e; }
			},
			getAllDonations: async () => {
				try { 
					if (!adminToken) await adminLogin();
					return await (await fetch('http://localhost:5000/admin/donations', { headers: getAuthHeaders() })).json(); 
				}
				catch (e) { throw e; }
			},
			getAllHospitals: async () => {
				try { 
					if (!adminToken) await adminLogin();
					return await (await fetch('http://localhost:5000/admin/hospitals', { headers: getAuthHeaders() })).json(); 
				}
				catch (e) { throw e; }
			},
			getAllPoliceStations: async () => {
				try { 
					if (!adminToken) await adminLogin();
					return await (await fetch('http://localhost:5000/admin/police-stations', { headers: getAuthHeaders() })).json(); 
				}
				catch (e) { throw e; }
			},
			getAllBloodBanks: async () => {
				try { 
					if (!adminToken) await adminLogin();
					return await (await fetch('http://localhost:5000/admin/blood-banks', { headers: getAuthHeaders() })).json(); 
				}
				catch (e) { throw e; }
			},
			getAllFireStations: async () => {
				try { 
					if (!adminToken) await adminLogin();
					return await (await fetch('http://localhost:5000/admin/fire-stations', { headers: getAuthHeaders() })).json(); 
				}
				catch (e) { throw e; }
			},
			getAllEmergencyContacts: async () => {
				try { 
					if (!adminToken) await adminLogin();
					return await (await fetch('http://localhost:5000/admin/emergency-contacts', { headers: getAuthHeaders() })).json(); 
				}
				catch (e) { throw e; }
			},
		};

		function formatDate(dateString) {
			return new Date(dateString).toLocaleDateString() + ' ' + new Date(dateString).toLocaleTimeString();
		}

		function getStatusBadge(status, approved = null) {
			if (approved !== null) {
				return approved ? '<span class="badge bg-success badge-status">Approved</span>' : '<span class="badge bg-warning badge-status">Pending</span>';
			}
			const statusMap = {
				'PENDING': 'warning',
				'IN_PROGRESS': 'info',
				'RESCUED': 'success',
				'CLOSED': 'secondary'
			};
			return `<span class="badge bg-${statusMap[status] || 'secondary'} badge-status">${status}</span>`;
		}

		function getUrgencyBadge(urgency) {
			const urgencyMap = {
				'Low': 'success',
				'Medium': 'warning',
				'Critical': 'danger'
			};
			return `<span class="badge bg-${urgencyMap[urgency] || 'secondary'} badge-status">${urgency}</span>`;
		}

		async function loadCases() {
			try {
				const data = await window.AdminApi.getAllCases();
				const tbody = document.getElementById('cases-table-body');
				if (data.cases && data.cases.length > 0) {
					tbody.innerHTML = data.cases.map(case_ => `
						<tr>
							<td><strong>${case_.case_code}</strong></td>
							<td>${case_.reporter_name || 'Anonymous'}<br><small>${case_.reporter_phone}</small></td>
							<td>${case_.location}</td>
							<td>${case_.animal_type}</td>
							<td>${getUrgencyBadge(case_.urgency)}</td>
							<td>${getStatusBadge(case_.status)}</td>
							<td><small>${formatDate(case_.created_at)}</small></td>
						</tr>
					`).join('');
				} else {
					tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No cases found</td></tr>';
				}
				document.getElementById('total-cases').textContent = data.cases ? data.cases.length : 0;
			} catch (error) {
				window.ToastManager?.error('Failed to load cases');
				document.getElementById('cases-table-body').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading cases</td></tr>';
			}
		}

		async function loadNGOs() {
			try {
				const data = await window.AdminApi.getAllNGOs();
				const tbody = document.getElementById('ngos-table-body');
				if (data.ngos && data.ngos.length > 0) {
					tbody.innerHTML = data.ngos.map(ngo => `
						<tr>
							<td><strong>${ngo.name}</strong></td>
							<td>${ngo.email}</td>
							<td>${ngo.phone}</td>
							<td>${ngo.location || '-'}</td>
							<td>${ngo.operating_zones || '-'}</td>
							<td>${getStatusBadge(null, ngo.approved)}</td>
							<td><small>${formatDate(ngo.created_at)}</small></td>
						</tr>
					`).join('');
				} else {
					tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No NGOs found</td></tr>';
				}
				document.getElementById('total-ngos').textContent = data.ngos ? data.ngos.length : 0;
			} catch (error) {
				window.ToastManager?.error('Failed to load NGOs');
				document.getElementById('ngos-table-body').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading NGOs</td></tr>';
			}
		}

		async function loadVolunteers() {
			try {
				const data = await window.AdminApi.getAllVolunteers();
				const tbody = document.getElementById('volunteers-table-body');
				if (data.volunteers && data.volunteers.length > 0) {
					tbody.innerHTML = data.volunteers.map(vol => `
						<tr>
							<td><strong>${vol.name}</strong></td>
							<td>${vol.email}</td>
							<td>${vol.phone}</td>
							<td>${vol.expertise || '-'}</td>
							<td>${vol.location || '-'}</td>
							<td>${getStatusBadge(null, vol.approved)}</td>
							<td><small>${formatDate(vol.created_at)}</small></td>
						</tr>
					`).join('');
				} else {
					tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No volunteers found</td></tr>';
				}
				document.getElementById('total-volunteers').textContent = data.volunteers ? data.volunteers.length : 0;
			} catch (error) {
				window.ToastManager?.error('Failed to load volunteers');
				document.getElementById('volunteers-table-body').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading volunteers</td></tr>';
			}
		}

		async function loadDonations() {
			try {
				const data = await window.AdminApi.getAllDonations();
				const tbody = document.getElementById('donations-table-body');
				if (data.donations && data.donations.length > 0) {
					tbody.innerHTML = data.donations.map(donation => `
						<tr>
							<td>${donation.donor_name || 'Anonymous'}<br><small>${donation.donor_email || ''}</small></td>
							<td><strong>${donation.currency} ${donation.amount}</strong></td>
							<td>${donation.category}</td>
							<td><small>${donation.payment_id || '-'}</small></td>
							<td><small>${formatDate(donation.created_at)}</small></td>
						</tr>
					`).join('');
				} else {
					tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No donations found</td></tr>';
				}
				document.getElementById('total-donations').textContent = data.donations ? data.donations.length : 0;
			} catch (error) {
				window.ToastManager?.error('Failed to load donations');
				document.getElementById('donations-table-body').innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading donations</td></tr>';
			}
		}

		async function loadHospitals() {
			try {
				const data = await window.AdminApi.getAllHospitals();
				window.hospitalsData = data.hospitals || []; // Store globally for map
				const tbody = document.getElementById('hospitals-table-body');
				if (data.hospitals && data.hospitals.length > 0) {
					tbody.innerHTML = data.hospitals.map(hospital => `
						<tr>
							<td><strong>${hospital.name}</strong></td>
							<td>${hospital.address || '-'}</td>
							<td>${hospital.phone || '-'}</td>
							<td>${hospital.is_24x7 ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td>
							<td>${hospital.treatment_types || '-'}</td>
							<td><small>${formatDate(hospital.created_at)}</small></td>
						</tr>
					`).join('');
				} else {
					tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hospitals found</td></tr>';
				}
				
				// Refresh map if it exists
				if (adminMaps.hospitals) {
					loadMapMarkers('hospitals');
				}
			} catch (error) {
				window.ToastManager?.error('Failed to load hospitals');
				document.getElementById('hospitals-table-body').innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading hospitals</td></tr>';
			}
		}

		async function loadPoliceStations() {
			try {
				const data = await window.AdminApi.getAllPoliceStations();
				window.policeData = data.police_stations || []; // Store globally for map
				const tbody = document.getElementById('police-table-body');
				if (data.police_stations && data.police_stations.length > 0) {
					tbody.innerHTML = data.police_stations.map(station => `
						<tr>
							<td><strong>${station.name}</strong></td>
							<td>${station.address || '-'}</td>
							<td>${station.phone || '-'}</td>
							<td>${station.station_code || '-'}</td>
							<td>${station.jurisdiction || '-'}</td>
							<td>${station.officer_in_charge || '-'}</td>
							<td>${station.is_24x7 ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td>
							<td><small>${formatDate(station.created_at)}</small></td>
						</tr>
					`).join('');
				} else {
					tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No police stations found</td></tr>';
				}
				
				// Refresh map if it exists
				if (adminMaps.police) {
					loadMapMarkers('police');
				}
			} catch (error) {
				window.ToastManager?.error('Failed to load police stations');
				document.getElementById('police-table-body').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading police stations</td></tr>';
			}
		}

		async function loadBloodBanks() {
			try {
				const data = await window.AdminApi.getAllBloodBanks();
				const tbody = document.getElementById('blood-banks-table-body');
				if (data.blood_banks && data.blood_banks.length > 0) {
					tbody.innerHTML = data.blood_banks.map(bank => `
						<tr>
							<td><strong>${bank.name}</strong></td>
							<td>${bank.address || '-'}</td>
							<td>${bank.phone || '-'}</td>
							<td>${bank.contact_person || '-'}</td>
							<td>${bank.blood_types_available || '-'}</td>
							<td>${bank.license_number || '-'}</td>
							<td>${bank.is_24x7 ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td>
							<td><small>${formatDate(bank.created_at)}</small></td>
						</tr>
					`).join('');
				} else {
					tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No blood banks found</td></tr>';
				}
			} catch (error) {
				window.ToastManager?.error('Failed to load blood banks');
				document.getElementById('blood-banks-table-body').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading blood banks</td></tr>';
			}
		}

		async function loadFireStations() {
			try {
				const data = await window.AdminApi.getAllFireStations();
				const tbody = document.getElementById('fire-stations-table-body');
				if (data.fire_stations && data.fire_stations.length > 0) {
					tbody.innerHTML = data.fire_stations.map(station => `
						<tr>
							<td><strong>${station.name}</strong></td>
							<td>${station.address || '-'}</td>
							<td>${station.phone || '-'}</td>
							<td>${station.station_code || '-'}</td>
							<td>${station.equipment_available || '-'}</td>
							<td>${station.chief_officer || '-'}</td>
							<td>${station.is_24x7 ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td>
							<td><small>${formatDate(station.created_at)}</small></td>
						</tr>
					`).join('');
				} else {
					tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No fire stations found</td></tr>';
				}
			} catch (error) {
				window.ToastManager?.error('Failed to load fire stations');
				document.getElementById('fire-stations-table-body').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading fire stations</td></tr>';
			}
		}

		async function loadEmergencyContacts() {
			try {
				const data = await window.AdminApi.getAllEmergencyContacts();
				const tbody = document.getElementById('emergency-contacts-table-body');
				if (data.emergency_contacts && data.emergency_contacts.length > 0) {
					tbody.innerHTML = data.emergency_contacts.map(contact => `
						<tr>
							<td><strong>${contact.name}</strong></td>
							<td>${contact.phone}</td>
							<td>${contact.email || '-'}</td>
							<td><span class="badge bg-info">${contact.service_type}</span></td>
							<td>${contact.location || '-'}</td>
							<td><span class="badge bg-${contact.priority_level === 1 ? 'danger' : contact.priority_level === 2 ? 'warning' : 'secondary'}">${contact.priority_level === 1 ? 'High' : contact.priority_level === 2 ? 'Medium' : 'Low'}</span></td>
							<td>${contact.is_24x7 ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td>
							<td><small>${formatDate(contact.created_at)}</small></td>
						</tr>
					`).join('');
				} else {
					tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No emergency contacts found</td></tr>';
				}
			} catch (error) {
				window.ToastManager?.error('Failed to load emergency contacts');
				document.getElementById('emergency-contacts-table-body').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading emergency contacts</td></tr>';
			}
		}

		async function loadAllData() {
			const refreshBtn = document.querySelector('.refresh-btn');
			window.LoadingOverlay?.show();
			window.ButtonLoader?.setLoading(refreshBtn, true);
			let failures = 0;
			await Promise.all([
				loadCases().catch(() => { failures++; }),
				loadNGOs().catch(() => { failures++; }),
				loadVolunteers().catch(() => { failures++; }),
				loadDonations().catch(() => { failures++; }),
				loadHospitals().catch(() => { failures++; }),
				loadPoliceStations().catch(() => { failures++; }),
				loadBloodBanks().catch(() => { failures++; }),
				loadFireStations().catch(() => { failures++; }),
				loadEmergencyContacts().catch(() => { failures++; })
			]);
			window.ButtonLoader?.setLoading(refreshBtn, false);
			window.LoadingOverlay?.hide();
			if (failures > 0) window.ToastManager?.error(`Failed to load ${failures} section${failures>1?'s':''}`); else window.ToastManager?.success('Dashboard refreshed');
		}

		// CSV Upload functionality
		let currentServiceType = null;
		
		const csvFormats = {
			'hospitals': 'Required columns: name, address, phone, location, is_24x7, treatment_types',
			'police-stations': 'Required columns: name, address, phone, location, station_code, jurisdiction, officer_in_charge, is_24x7',
			'blood-banks': 'Required columns: name, address, phone, location, blood_types_available, contact_person, license_number, is_24x7',
			'fire-stations': 'Required columns: name, address, phone, location, station_code, equipment_available, chief_officer, is_24x7',
			'emergency-contacts': 'Required columns: name, phone, email, service_type, location, description, priority_level, is_24x7'
		};
		
		function openUploadModal(serviceType) {
			currentServiceType = serviceType;
			document.getElementById('csvFormatInfo').textContent = csvFormats[serviceType] || 'Please check the required columns.';
			document.getElementById('csvFile').value = '';
			document.getElementById('uploadProgress').classList.add('d-none');
			document.getElementById('uploadResult').classList.add('d-none');
			new bootstrap.Modal(document.getElementById('csvUploadModal')).show();
		}
		
		async function uploadCSV() {
			const fileInput = document.getElementById('csvFile');
			const file = fileInput.files[0];
			
			if (!file) {
				window.ToastManager?.error('Please select a CSV file');
				return;
			}
			
			if (!currentServiceType) {
				window.ToastManager?.error('Service type not selected');
				return;
			}
			
			const formData = new FormData();
			formData.append('file', file);
			
			// Show progress
			document.getElementById('uploadProgress').classList.remove('d-none');
			document.getElementById('uploadBtn').disabled = true;
			
			try {
				if (!adminToken) await adminLogin();
				
				const response = await fetch(`http://localhost:5000/admin/upload-csv/${currentServiceType}`, {
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${adminToken}`
					},
					body: formData
				});
				
				const result = await response.json();
				
				// Hide progress
				document.getElementById('uploadProgress').classList.add('d-none');
				
				// Show results
				const resultDiv = document.getElementById('uploadResult');
				resultDiv.classList.remove('d-none');
				
				if (response.ok) {
					resultDiv.innerHTML = `
						<div class="alert alert-success">
							<h6>‚úÖ Upload Successful!</h6>
							<p><strong>Imported:</strong> ${result.imported_count} records</p>
							${result.errors && result.errors.length > 0 ? 
								`<p><strong>Errors:</strong> ${result.errors.length}</p>
								<details><summary>View Errors</summary><ul>${result.errors.map(e => `<li>${e}</li>`).join('')}</ul></details>` 
								: ''}
						</div>
					`;
					window.ToastManager?.success(`Successfully imported ${result.imported_count} records`);
					
					// Refresh the relevant data
					setTimeout(() => {
						loadAllData();
					}, 1000);
				} else {
					resultDiv.innerHTML = `
						<div class="alert alert-danger">
							<h6>‚ùå Upload Failed</h6>
							<p>${result.error || 'Unknown error occurred'}</p>
						</div>
					`;
					window.ToastManager?.error(result.error || 'Upload failed');
				}
			} catch (error) {
				document.getElementById('uploadProgress').classList.add('d-none');
				document.getElementById('uploadResult').classList.remove('d-none');
				document.getElementById('uploadResult').innerHTML = `
					<div class="alert alert-danger">
						<h6>‚ùå Upload Failed</h6>
						<p>Network error: ${error.message}</p>
					</div>
				`;
				window.ToastManager?.error('Upload failed: ' + error.message);
			} finally {
				document.getElementById('uploadBtn').disabled = false;
			}
		}

		function downloadSample(serviceType) {
			const sampleFiles = {
				'hospitals': 'hospitals_sample.csv',
				'police-stations': 'police_stations_sample.csv',
				'blood-banks': 'blood_banks_sample.csv',
				'fire-stations': 'fire_stations_sample.csv',
				'emergency-contacts': 'emergency_contacts_sample.csv'
			};
			
			const fileName = sampleFiles[serviceType];
			if (fileName) {
				window.open(`./sample_data/${fileName}`, '_blank');
			}
		}

		// Map functionality
		function switchAdminView(tabName, viewType) {
			const tableView = document.getElementById(`${tabName}-table-view`);
			const mapView = document.getElementById(`${tabName}-map-view`);
			const buttons = document.querySelectorAll(`#${tabName} .btn-group button`);
			
			buttons.forEach(btn => btn.classList.remove('active'));
			
			if (viewType === 'table') {
				tableView.classList.remove('d-none');
				mapView.classList.add('d-none');
				buttons[0].classList.add('active');
			} else {
				tableView.classList.add('d-none');
				mapView.classList.remove('d-none');
				buttons[1].classList.add('active');
				
				// Initialize map if not already done
				if (!adminMaps[tabName]) {
					initAdminMap(tabName);
				}
			}
		}
		
		function initAdminMap(tabName) {
			const mapElement = document.getElementById(`${tabName}-map`);
			if (!mapElement) return;
			
			// Initialize Leaflet map centered on India
			const map = L.map(mapElement).setView([20.5937, 78.9629], 5);
			
			// Add OpenStreetMap tiles
			L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
				maxZoom: 19
			}).addTo(map);
			
			adminMaps[tabName] = map;
			adminMarkers[tabName] = [];
			
			// Load markers for this tab
			loadMapMarkers(tabName);
		}
		
		function loadMapMarkers(tabName) {
			const map = adminMaps[tabName];
			if (!map) return;
			
			// Clear existing markers
			if (adminMarkers[tabName]) {
				adminMarkers[tabName].forEach(marker => map.removeLayer(marker));
				adminMarkers[tabName] = [];
			}
			
			// Load data based on tab type
			switch(tabName) {
				case 'hospitals':
					loadHospitalMarkers(map, tabName);
					break;
				case 'police':
					loadPoliceMarkers(map, tabName);
					break;
				// Add more cases as needed
			}
		}
		
		function loadHospitalMarkers(map, tabName) {
			// This would be called after hospitals data is loaded
			if (window.hospitalsData) {
				window.hospitalsData.forEach(hospital => {
					if (hospital.location) {
						geocodeHospitalLocation(hospital.location, hospital, map, tabName);
					}
				});
			}
		}
		
		async function geocodeHospitalLocation(location, hospital, map, tabName) {
			try {
				// Use Nominatim API for geocoding
				const response = await fetch(
					`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&limit=1&countrycodes=in`
				);
				
				if (!response.ok) {
					throw new Error('Geocoding request failed');
				}
				
				const results = await response.json();
				
				if (results.length > 0) {
					const lat = parseFloat(results[0].lat);
					const lon = parseFloat(results[0].lon);
					
					// Create custom hospital icon
					const hospitalIcon = L.divIcon({
						className: 'custom-hospital-icon',
						html: 'üè•',
						iconSize: [30, 30],
						iconAnchor: [15, 15]
					});
					
					// Add marker
					const marker = L.marker([lat, lon], { icon: hospitalIcon }).addTo(map);
					
					// Create popup content
					const popupContent = `
						<div style="min-width: 200px;">
							<h6 style="margin: 0 0 8px 0; color: #333;">${hospital.name}</h6>
							${hospital.address ? `<p style="margin: 0 0 4px 0; font-size: 0.9em;"><strong>Address:</strong> ${hospital.address}</p>` : ''}
							${hospital.phone ? `<p style="margin: 0 0 4px 0; font-size: 0.9em;"><strong>Phone:</strong> <a href="tel:${hospital.phone}">${hospital.phone}</a></p>` : ''}
							${hospital.treatment_types ? `<p style="margin: 0 0 4px 0; font-size: 0.9em;"><strong>Services:</strong> ${hospital.treatment_types}</p>` : ''}
							<p style="margin: 0; font-size: 0.9em;">
								<span class="badge ${hospital.is_24x7 ? 'bg-success' : 'bg-secondary'}">${hospital.is_24x7 ? '24x7 Available' : 'Limited Hours'}</span>
							</p>
						</div>
					`;
					
					// Bind popup to marker
					marker.bindPopup(popupContent);
					
					adminMarkers[tabName].push(marker);
				} else {
					console.warn('Geocoding failed for:', location);
				}
			} catch (error) {
				console.error('Geocoding error for:', location, error);
			}
		}
		
		function loadPoliceMarkers(map, tabName) {
			// This would be called after police data is loaded
			if (window.policeData) {
				window.policeData.forEach(station => {
					if (station.location) {
						geocodePoliceLocation(station.location, station, map, tabName);
					}
				});
			}
		}
		
		async function geocodePoliceLocation(location, station, map, tabName) {
			try {
				// Use Nominatim API for geocoding
				const response = await fetch(
					`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&limit=1&countrycodes=in`
				);
				
				if (!response.ok) {
					throw new Error('Geocoding request failed');
				}
				
				const results = await response.json();
				
				if (results.length > 0) {
					const lat = parseFloat(results[0].lat);
					const lon = parseFloat(results[0].lon);
					
					// Create custom police icon
					const policeIcon = L.divIcon({
						className: 'custom-marker-icon',
						html: 'üöî',
						iconSize: [30, 30],
						iconAnchor: [15, 15]
					});
					
					// Add marker
					const marker = L.marker([lat, lon], { icon: policeIcon }).addTo(map);
					
					// Create popup content
					const popupContent = `
						<div style="min-width: 200px;">
							<h6 style="margin: 0 0 8px 0; color: #333;">${station.name}</h6>
							${station.address ? `<p style="margin: 0 0 4px 0; font-size: 0.9em;"><strong>Address:</strong> ${station.address}</p>` : ''}
							${station.phone ? `<p style="margin: 0 0 4px 0; font-size: 0.9em;"><strong>Phone:</strong> <a href="tel:${station.phone}">${station.phone}</a></p>` : ''}
							${station.station_code ? `<p style="margin: 0 0 4px 0; font-size: 0.9em;"><strong>Station Code:</strong> ${station.station_code}</p>` : ''}
							<p style="margin: 0; font-size: 0.9em;">
								<span class="badge ${station.is_24x7 ? 'bg-success' : 'bg-secondary'}">${station.is_24x7 ? '24x7 Available' : 'Limited Hours'}</span>
							</p>
						</div>
					`;
					
					// Bind popup to marker
					marker.bindPopup(popupContent);
					
					adminMarkers[tabName].push(marker);
				} else {
					console.warn('Geocoding failed for:', location);
				}
			} catch (error) {
				console.error('Geocoding error for:', location, error);
			}
		}
		
		function geocodeAndAddMarker(map, location, data, icon) {
			fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&limit=1`)
				.then(response => response.json())
				.then(geocodeData => {
					if (geocodeData && geocodeData.length > 0) {
						const lat = parseFloat(geocodeData[0].lat);
						const lon = parseFloat(geocodeData[0].lon);
						
						const customIcon = L.divIcon({
							className: 'custom-marker-icon',
							html: icon,
							iconSize: [30, 30],
							iconAnchor: [15, 15]
						});
						
						const marker = L.marker([lat, lon], { icon: customIcon }).addTo(map);
						
						// Create popup content based on data type
						let popupContent = `<div style="min-width: 200px;"><h6 style="margin: 0 0 8px 0;">${data.name}</h6>`;
						if (data.address) popupContent += `<p style="margin: 0 0 4px 0; font-size: 0.9em;"><strong>Address:</strong> ${data.address}</p>`;
						if (data.phone) popupContent += `<p style="margin: 0 0 4px 0; font-size: 0.9em;"><strong>Phone:</strong> <a href="tel:${data.phone}">${data.phone}</a></p>`;
						popupContent += '</div>';
						
						marker.bindPopup(popupContent);
					}
				})
				.catch(error => console.warn('Geocoding failed for:', location, error));
		}
		
		function openAddLocationModal(locationType) {
			currentLocationType = locationType;
			document.getElementById('addLocationModalLabel').textContent = `üìç Add New ${locationType.charAt(0).toUpperCase() + locationType.slice(1).replace('-', ' ')}`;
			
			// Clear form
			document.getElementById('locationForm').reset();
			document.getElementById('selectedLocation').textContent = 'Not selected';
			selectedLocation = null;
			
			// Add additional fields based on location type
			addAdditionalFields(locationType);
			
			// Initialize location picker map
			initLocationPickerMap();
			
			new bootstrap.Modal(document.getElementById('addLocationModal')).show();
		}
		
		function addAdditionalFields(locationType) {
			const additionalFields = document.getElementById('additionalFields');
			let fieldsHTML = '';
			
			switch(locationType) {
				case 'hospital':
					fieldsHTML = `
						<div class="mb-3">
							<label for="treatmentTypes" class="form-label">Treatment Types</label>
							<input type="text" class="form-control" id="treatmentTypes" placeholder="e.g., Surgery, First Aid, Emergency">
						</div>
					`;
					break;
				case 'police-station':
					fieldsHTML = `
						<div class="mb-3">
							<label for="stationCode" class="form-label">Station Code</label>
							<input type="text" class="form-control" id="stationCode">
						</div>
						<div class="mb-3">
							<label for="jurisdiction" class="form-label">Jurisdiction</label>
							<input type="text" class="form-control" id="jurisdiction">
						</div>
						<div class="mb-3">
							<label for="officerInCharge" class="form-label">Officer in Charge</label>
							<input type="text" class="form-control" id="officerInCharge">
						</div>
					`;
					break;
			}
			
			additionalFields.innerHTML = fieldsHTML;
		}
		
		function initLocationPickerMap() {
			if (locationPickerMap) {
				locationPickerMap.remove();
				locationPickerMap = null;
			}
			
			locationPickerMap = L.map('locationPickerMap').setView([20.5937, 78.9629], 6);
			
			// Add OpenStreetMap tiles
			L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
				maxZoom: 19
			}).addTo(locationPickerMap);
			
			// Add click handler to map
			locationPickerMap.on('click', function(e) {
				const lat = e.latlng.lat;
				const lng = e.latlng.lng;
				
				selectedLocation = { lat, lng };
				document.getElementById('selectedLocation').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
				
				// Reverse geocode to get address
				reverseGeocodeLocation(lat, lng);
			});
		}
		
		async function reverseGeocodeLocation(lat, lng) {
			try {
				const response = await fetch(
					`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`
				);
				
				if (response.ok) {
					const data = await response.json();
					if (data.display_name) {
						document.getElementById('locationAddress').value = data.display_name;
					}
				}
			} catch (error) {
				console.error('Reverse geocoding error:', error);
			}
		}
		
		async function saveLocation() {
			if (!selectedLocation) {
				window.ToastManager?.error('Please select a location on the map');
				return;
			}
			
			const formData = {
				name: document.getElementById('locationName').value,
				address: document.getElementById('locationAddress').value,
				phone: document.getElementById('locationPhone').value,
				location: `${selectedLocation.lat}, ${selectedLocation.lng}`,
				is_24x7: document.getElementById('location24x7').value === 'true'
			};
			
			// Add additional fields based on location type
			switch(currentLocationType) {
				case 'hospital':
					formData.treatment_types = document.getElementById('treatmentTypes').value;
					break;
				case 'police-station':
					formData.station_code = document.getElementById('stationCode').value;
					formData.jurisdiction = document.getElementById('jurisdiction').value;
					formData.officer_in_charge = document.getElementById('officerInCharge').value;
					break;
			}
			
			try {
				if (!adminToken) await adminLogin();
				
				const endpoint = currentLocationType === 'police-station' ? 'police-stations' : currentLocationType + 's';
				const response = await fetch(`http://localhost:5000/admin/${endpoint}`, {
					method: 'POST',
					headers: getAuthHeaders(),
					body: JSON.stringify(formData)
				});
				
				if (response.ok) {
					window.ToastManager?.success('Location added successfully');
					bootstrap.Modal.getInstance(document.getElementById('addLocationModal')).hide();
					loadAllData(); // Refresh all data
				} else {
					const error = await response.json();
					window.ToastManager?.error(error.error || 'Failed to add location');
				}
			} catch (error) {
				window.ToastManager?.error('Failed to add location: ' + error.message);
			}
		}

		// Leaflet maps initialized
		function initLeafletMaps() {
			console.log('Leaflet maps initialized');
		}

		// Load data when page loads
		document.addEventListener('DOMContentLoaded', () => {
			// simple loading placeholders
			document.querySelectorAll('#cases-table-body,#ngos-table-body,#volunteers-table-body,#donations-table-body,#hospitals-table-body,#police-table-body,#blood-banks-table-body,#fire-stations-table-body,#emergency-contacts-table-body').forEach(tb => {
				tb.innerHTML = Array.from({length:3}).map(() => `<tr><td colspan="12"><div class='skeleton' style='height:16px;'></div></td></tr>`).join('');
			});
			loadAllData();
		});
	</script>
</body>
</html>
