<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Report Case - ResQTrack</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
	<link href="./assets/css/styles.css" rel="stylesheet" />
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
	<nav class="navbar navbar-expand-lg bg-body-tertiary">
		<div class="container">
			<a class="navbar-brand" href="./index.html">üêæ <span>ResQTrack</span></a>
		</div>
	</nav>
	<div class="container py-4">
		<a href="./index.html" class="back-btn mb-3">‚¨Ö Go Back to ResQTrack</a>
		<h1 class="h3 mb-3">Report Animal Case</h1>
		<form id="report-form" class="row g-3" enctype="multipart/form-data">
			<div class="col-md-6">
				<label class="form-label">Reporter Name (optional)</label>
				<input name="reporter_name" class="form-control" />
			</div>
			<div class="col-md-6">
				<label class="form-label">Contact Number</label>
				<input name="reporter_phone" class="form-control" required data-validate="required|phone" />
				<div class="invalid-feedback"></div>
			</div>
			<div class="col-md-6">
				<label class="form-label">Email (optional)</label>
				<input name="reporter_email" type="email" class="form-control" data-validate="email" />
				<div class="invalid-feedback"></div>
			</div>
			<div class="col-md-6">
				<label class="form-label">Location</label>
				<input name="location" class="form-control" required data-validate="required" id="locationInput" />
				<div class="invalid-feedback"></div>
				<button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="openLocationPicker()">
					üìç Select on Map
				</button>
			</div>
			<div class="col-md-4">
				<label class="form-label">Animal Type</label>
				<select name="animal_type" class="form-select">
					<option>Dog</option>
					<option>Cat</option>
					<option>Bird</option>
					<option>Other</option>
				</select>
			</div>
			<div class="col-md-4">
				<label class="form-label">Urgency</label>
				<select name="urgency" class="form-select">
					<option>Low</option>
					<option>Medium</option>
					<option>Critical</option>
				</select>
			</div>
			<div class="col-md-4">
				<label class="form-label">Upload Image/Video</label>
				<input type="file" name="file" class="form-control" />
			</div>
			<div class="col-12">
				<label class="form-label">Additional Notes</label>
				<textarea name="notes" class="form-control" rows="3"></textarea>
			</div>
			<div class="col-12">
				<button class="btn btn-gradient-orange" type="submit">Submit Report</button>
			</div>
		</form>
		<div id="result" class="alert d-none mt-3" role="alert" style="display:none"></div>
	</div>

	<!-- Location Picker Modal -->
	<div class="modal fade" id="locationPickerModal" tabindex="-1" aria-labelledby="locationPickerModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="locationPickerModalLabel">üìç Select Location</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<label class="form-label">Click on the map to select the exact location</label>
						<div id="reportLocationMap" style="height: 400px; border-radius: 8px; border: 1px solid #dee2e6;"></div>
					</div>
					<div class="row">
						<div class="col-md-6">
							<label class="form-label">Selected Coordinates</label>
							<input type="text" class="form-control" id="selectedCoords" readonly />
						</div>
						<div class="col-md-6">
							<label class="form-label">Address</label>
							<input type="text" class="form-control" id="selectedAddress" readonly />
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-primary" onclick="confirmLocation()">Use This Location</button>
				</div>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
	<script src="./assets/js/app.js"></script>
	<script src="./assets/js/api.js"></script>
	<script>
		let reportLocationMap = null;
		let selectedLocation = null;
		
		function openLocationPicker() {
			new bootstrap.Modal(document.getElementById('locationPickerModal')).show();
			
			// Initialize map if not already done
			if (!reportLocationMap) {
				initReportLocationMap();
			}
		}
		
		function initReportLocationMap() {
			reportLocationMap = L.map('reportLocationMap').setView([20.5937, 78.9629], 6);
			
			L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: '¬© OpenStreetMap contributors'
			}).addTo(reportLocationMap);
			
			// Add click handler to map
			reportLocationMap.on('click', function(e) {
				const lat = e.latlng.lat;
				const lng = e.latlng.lng;
				
				selectedLocation = { lat, lng };
				document.getElementById('selectedCoords').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
				
				// Reverse geocode to get address
				fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
					.then(response => response.json())
					.then(data => {
						if (data.display_name) {
							document.getElementById('selectedAddress').value = data.display_name;
						}
					})
					.catch(error => console.warn('Reverse geocoding failed:', error));
			});
		}
		
		function confirmLocation() {
			if (!selectedLocation) {
				if (window.ToastManager) window.ToastManager.error('Please select a location on the map');
				return;
			}
			
			const coords = document.getElementById('selectedCoords').value;
			const address = document.getElementById('selectedAddress').value;
			
			// Update the location input field
			document.getElementById('locationInput').value = address || coords;
			
			// Store coordinates for form submission
			document.getElementById('locationInput').setAttribute('data-lat', selectedLocation.lat);
			document.getElementById('locationInput').setAttribute('data-lng', selectedLocation.lng);
			
			// Close modal
			bootstrap.Modal.getInstance(document.getElementById('locationPickerModal')).hide();
			
			if (window.ToastManager) window.ToastManager.success('Location selected successfully');
		}
		const form = document.getElementById('report-form');
		const result = document.getElementById('result');
		document.addEventListener('DOMContentLoaded', () => {
			if (window.FormValidator) window.FormValidator.attachRealTimeValidation(form);
		});
		form.addEventListener('submit', async (e) => {
			e.preventDefault();
			const submitBtn = form.querySelector('button[type="submit"]');
			let allValid = true;
			form.querySelectorAll('[data-validate]').forEach((field) => {
				if (window.FormValidator && !window.FormValidator.validateField(field)) allValid = false;
			});
			if (!allValid) {
				if (window.ToastManager) window.ToastManager.error('Please fix validation errors');
				return;
			}
			const formData = new FormData(form);
			
			// Add coordinates if available
			const locationInput = document.getElementById('locationInput');
			if (locationInput.getAttribute('data-lat') && locationInput.getAttribute('data-lng')) {
				formData.append('latitude', locationInput.getAttribute('data-lat'));
				formData.append('longitude', locationInput.getAttribute('data-lng'));
			}
			
			try {
				const resp = await window.ResQApi.reportCase(formData, { buttonElement: submitBtn });
				if (window.ToastManager) window.ToastManager.success(`Thank you! Help is on the way. Case ID: ${resp.case_code}`);
				form.reset();
				form.querySelectorAll('.is-valid,.is-invalid').forEach(el => el.classList.remove('is-valid','is-invalid'));
				// Clear location data attributes
				locationInput.removeAttribute('data-lat');
				locationInput.removeAttribute('data-lng');
			} catch (err) {
				// api.js handles toasts; keep silent here
			}
		});
	</script>
</body>
</html>
