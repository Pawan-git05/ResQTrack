<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Picker - ResQTrack</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <!-- Custom CSS -->
    <style>
        body {
            font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background-color: #f8fafc;
        }
        
        .location-picker-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .search-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .map-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        #map {
            height: 500px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .location-info {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #2563eb, #1d4ed8);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            padding: 12px 24px;
        }
        
        .btn-success {
            background: linear-gradient(90deg, #10b981, #059669);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            padding: 12px 24px;
        }
        
        .btn-outline-primary {
            border-color: #2563eb;
            color: #2563eb;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .btn-outline-primary:hover {
            background-color: #2563eb;
            border-color: #2563eb;
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #d1d5db;
            padding: 12px 16px;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.15);
        }
        
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            position: absolute;
            width: 100%;
            z-index: 1000;
            display: none;
        }
        
        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .search-result-item:hover {
            background-color: #f8fafc;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .location-details {
            background: #f8fafc;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }
        
        .coordinate-display {
            font-family: 'Courier New', monospace;
            background: #e5e7eb;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            color: #dc2626;
            font-size: 14px;
            margin-top: 8px;
        }
        
        .success-message {
            color: #059669;
            font-size: 14px;
            margin-top: 8px;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .location-picker-container {
                padding: 10px;
            }
            
            #map {
                height: 400px;
            }
            
            .search-container, .map-container, .location-info {
                padding: 15px;
            }
        }
        
        /* Custom marker styles */
        .custom-marker {
            background: #2563eb;
            border: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .custom-marker.selected {
            background: #dc2626;
            width: 24px;
            height: 24px;
        }
    </style>
</head>
<body>
    <div class="location-picker-container">
        <div class="text-center mb-4">
            <h1 class="h2 mb-2">üìç Location Picker</h1>
            <p class="text-muted">Select a location by searching, using your device location, or clicking on the map</p>
        </div>
        
        <!-- Search Container -->
        <div class="search-container">
            <h5 class="mb-3">üîç Search for a Location</h5>
            <div class="row">
                <div class="col-md-8">
                    <div class="position-relative">
                        <input type="text" 
                               id="locationSearch" 
                               class="form-control" 
                               placeholder="Enter address, city, landmark, or coordinates (e.g., Delhi, India or 28.6139, 77.2090)"
                               autocomplete="off">
                        <div id="searchResults" class="search-results"></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <button id="useCurrentLocation" class="btn btn-outline-primary w-100">
                        üìç Use My Location
                    </button>
                </div>
            </div>
            <div id="searchError" class="error-message" style="display: none;"></div>
        </div>
        
        <!-- Map Container -->
        <div class="map-container">
            <h5 class="mb-3">üó∫Ô∏è Interactive Map</h5>
            <div id="map"></div>
            <div class="mt-3">
                <small class="text-muted">
                    üí° <strong>Tip:</strong> Click anywhere on the map to set your location. 
                    You can also drag the map to explore different areas.
                </small>
            </div>
        </div>
        
        <!-- Location Information -->
        <div class="location-info">
            <h5 class="mb-3">üìç Selected Location Details</h5>
            <div id="locationDetails">
                <div class="text-center text-muted">
                    <p>No location selected yet</p>
                    <p class="small">Search for a location, use your current location, or click on the map above</p>
                </div>
            </div>
            
            <div class="mt-4">
                <div class="row">
                    <div class="col-md-6">
                        <button id="confirmLocation" class="btn btn-success w-100" disabled>
                            ‚úÖ Confirm Location
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button id="resetLocation" class="btn btn-outline-primary w-100">
                            üîÑ Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Results Display -->
        <div id="resultsDisplay" class="location-info mt-4" style="display: none;">
            <h5 class="mb-3">‚úÖ Location Confirmed</h5>
            <div id="finalResults"></div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>

    <script>
        // Global variables
        let map;
        let selectedMarker;
        let selectedLocation = null;
        let searchTimeout;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            setupEventListeners();
        });
        
        /**
         * Initialize the Leaflet map
         * Centers on India by default
         */
        function initializeMap() {
            // Initialize map centered on India
            map = L.map('map').setView([20.5937, 78.9629], 5);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Add click event listener to map
            map.on('click', function(e) {
                setLocation(e.latlng.lat, e.latlng.lng);
            });
            
            console.log('Map initialized successfully');
        }
        
        /**
         * Setup all event listeners
         */
        function setupEventListeners() {
            // Location search input
            const searchInput = document.getElementById('locationSearch');
            searchInput.addEventListener('input', handleSearchInput);
            searchInput.addEventListener('blur', function() {
                // Delay hiding results to allow clicking on them
                setTimeout(() => {
                    document.getElementById('searchResults').style.display = 'none';
                }, 200);
            });
            
            // Use current location button
            document.getElementById('useCurrentLocation').addEventListener('click', useCurrentLocation);
            
            // Confirm location button
            document.getElementById('confirmLocation').addEventListener('click', confirmLocation);
            
            // Reset location button
            document.getElementById('resetLocation').addEventListener('click', resetLocation);
        }
        
        /**
         * Handle search input with debouncing
         */
        function handleSearchInput(e) {
            const query = e.target.value.trim();
            
            // Clear previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            // Hide results if query is empty
            if (!query) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }
            
            // Debounce search to avoid too many API calls
            searchTimeout = setTimeout(() => {
                searchLocation(query);
            }, 300);
        }
        
        /**
         * Search for locations using Nominatim API
         */
        async function searchLocation(query) {
            const resultsContainer = document.getElementById('searchResults');
            const errorElement = document.getElementById('searchError');
            
            try {
                // Show loading state
                resultsContainer.innerHTML = '<div class="search-result-item text-center"><div class="loading-spinner"></div> Searching...</div>';
                resultsContainer.style.display = 'block';
                errorElement.style.display = 'none';
                
                // Call Nominatim API
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=in&addressdetails=1`
                );
                
                if (!response.ok) {
                    throw new Error('Search request failed');
                }
                
                const results = await response.json();
                
                if (results.length === 0) {
                    resultsContainer.innerHTML = '<div class="search-result-item text-center text-muted">No locations found</div>';
                    return;
                }
                
                // Display search results
                resultsContainer.innerHTML = results.map(result => `
                    <div class="search-result-item" onclick="selectSearchResult(${result.lat}, ${result.lon}, '${result.display_name.replace(/'/g, "\\'")}')">
                        <div class="fw-bold">${result.display_name}</div>
                        <div class="small text-muted">${result.lat}, ${result.lon}</div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Search error:', error);
                errorElement.textContent = 'Search failed. Please try again.';
                errorElement.style.display = 'block';
                resultsContainer.style.display = 'none';
            }
        }
        
        /**
         * Handle selection of a search result
         */
        function selectSearchResult(lat, lon, displayName) {
            setLocation(lat, lon, displayName);
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('locationSearch').value = displayName;
        }
        
        /**
         * Use the user's current location
         */
        function useCurrentLocation() {
            const button = document.getElementById('useCurrentLocation');
            const originalText = button.innerHTML;
            
            // Show loading state
            button.innerHTML = '<div class="loading-spinner"></div> Getting location...';
            button.disabled = true;
            
            if (!navigator.geolocation) {
                showError('Geolocation is not supported by this browser.');
                resetButton();
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    // Reverse geocode to get address
                    reverseGeocode(lat, lon).then(address => {
                        setLocation(lat, lon, address);
                        resetButton();
                    }).catch(() => {
                        setLocation(lat, lon);
                        resetButton();
                    });
                },
                function(error) {
                    let errorMessage = 'Unable to get your location. ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Please allow location access and try again.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Location information is unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Location request timed out.';
                            break;
                    }
                    showError(errorMessage);
                    resetButton();
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000 // 5 minutes
                }
            );
            
            function resetButton() {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        /**
         * Set the selected location on the map
         */
        function setLocation(lat, lon, address = null) {
            // Remove existing marker
            if (selectedMarker) {
                map.removeLayer(selectedMarker);
            }
            
            // Create new marker
            selectedMarker = L.marker([lat, lon], {
                icon: L.divIcon({
                    className: 'custom-marker selected',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                })
            }).addTo(map);
            
            // Center map on selected location
            map.setView([lat, lon], 15);
            
            // Store selected location
            selectedLocation = {
                latitude: lat,
                longitude: lon,
                address: address
            };
            
            // Update location details
            updateLocationDetails(lat, lon, address);
            
            // Enable confirm button
            document.getElementById('confirmLocation').disabled = false;
            
            console.log('Location set:', selectedLocation);
        }
        
        /**
         * Update the location details display
         */
        function updateLocationDetails(lat, lon, address = null) {
            const detailsContainer = document.getElementById('locationDetails');
            
            let addressText = address;
            if (!addressText) {
                addressText = 'Address not available';
            }
            
            detailsContainer.innerHTML = `
                <div class="location-details">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-2">üìç Address</h6>
                            <p class="mb-3">${addressText}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-2">üåê Coordinates</h6>
                            <div class="coordinate-display">
                                Latitude: ${lat.toFixed(6)}<br>
                                Longitude: ${lon.toFixed(6)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        /**
         * Reverse geocode coordinates to get address
         */
        async function reverseGeocode(lat, lon) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`
                );
                
                if (!response.ok) {
                    throw new Error('Reverse geocoding failed');
                }
                
                const data = await response.json();
                return data.display_name || 'Address not available';
                
            } catch (error) {
                console.error('Reverse geocoding error:', error);
                return 'Address not available';
            }
        }
        
        /**
         * Confirm the selected location
         */
        function confirmLocation() {
            if (!selectedLocation) {
                showError('Please select a location first.');
                return;
            }
            
            // Display final results
            const resultsDisplay = document.getElementById('resultsDisplay');
            const finalResults = document.getElementById('finalResults');
            
            finalResults.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="mb-2">üìç Selected Address</h6>
                        <p class="mb-3">${selectedLocation.address || 'Address not available'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="mb-2">üåê Coordinates</h6>
                        <div class="coordinate-display">
                            Latitude: ${selectedLocation.latitude.toFixed(6)}<br>
                            Longitude: ${selectedLocation.longitude.toFixed(6)}
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <h6 class="mb-2">üì§ Send to Backend</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-primary w-100" onclick="sendToBackend()">
                                üöÄ Send to Backend
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary w-100" onclick="copyCoordinates()">
                                üìã Copy Coordinates
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            resultsDisplay.style.display = 'block';
            resultsDisplay.scrollIntoView({ behavior: 'smooth' });
            
            console.log('Location confirmed:', selectedLocation);
        }
        
        /**
         * Send location data to backend
         */
        async function sendToBackend() {
            if (!selectedLocation) return;
            
            const button = event.target;
            const originalText = button.innerHTML;
            
            // Show loading state
            button.innerHTML = '<div class="loading-spinner"></div> Sending...';
            button.disabled = true;
            
            try {
                // Example backend endpoint - replace with your actual endpoint
                const response = await fetch('/api/location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        latitude: selectedLocation.latitude,
                        longitude: selectedLocation.longitude,
                        address: selectedLocation.address,
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    showSuccess('Location sent to backend successfully!');
                } else {
                    throw new Error('Backend request failed');
                }
                
            } catch (error) {
                console.error('Backend error:', error);
                showError('Failed to send location to backend. Check console for details.');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        /**
         * Copy coordinates to clipboard
         */
        async function copyCoordinates() {
            if (!selectedLocation) return;
            
            const coordinates = `${selectedLocation.latitude}, ${selectedLocation.longitude}`;
            
            try {
                await navigator.clipboard.writeText(coordinates);
                showSuccess('Coordinates copied to clipboard!');
            } catch (error) {
                console.error('Copy error:', error);
                showError('Failed to copy coordinates. Please copy manually.');
            }
        }
        
        /**
         * Reset the location picker
         */
        function resetLocation() {
            // Clear selected location
            selectedLocation = null;
            
            // Remove marker
            if (selectedMarker) {
                map.removeLayer(selectedMarker);
                selectedMarker = null;
            }
            
            // Reset map view
            map.setView([20.5937, 78.9629], 5);
            
            // Clear form
            document.getElementById('locationSearch').value = '';
            document.getElementById('searchResults').style.display = 'none';
            
            // Reset location details
            document.getElementById('locationDetails').innerHTML = `
                <div class="text-center text-muted">
                    <p>No location selected yet</p>
                    <p class="small">Search for a location, use your current location, or click on the map above</p>
                </div>
            `;
            
            // Hide results display
            document.getElementById('resultsDisplay').style.display = 'none';
            
            // Disable confirm button
            document.getElementById('confirmLocation').disabled = true;
            
            // Clear any error messages
            document.getElementById('searchError').style.display = 'none';
            
            console.log('Location picker reset');
        }
        
        /**
         * Show error message
         */
        function showError(message) {
            const errorElement = document.getElementById('searchError');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            errorElement.className = 'error-message';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }
        
        /**
         * Show success message
         */
        function showSuccess(message) {
            const errorElement = document.getElementById('searchError');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            errorElement.className = 'success-message';
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 3000);
        }
        
        // Make functions globally available for onclick handlers
        window.selectSearchResult = selectSearchResult;
        window.sendToBackend = sendToBackend;
        window.copyCoordinates = copyCoordinates;
    </script>
</body>
</html>
